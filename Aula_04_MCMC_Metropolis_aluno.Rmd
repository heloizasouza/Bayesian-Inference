---
title: "Aula 04: Amostrador de Metropolis"
author: "Prof. Dr. Eder Angelo Milani"
date: "21/07/2023"
output: 
  pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# O amostrador de Metropolis

O amostrador de Metropolis-Hastings é uma generalização do amostrador de Metropolis. No algoritmo de Metropolis, a distribuição de proposta é simétrica. Isto é, a distribuição de proposta $g(. | x_t)$ satisfaz  

$$g(X|Y) = g(Y|X),$$
com isso,  

$$r(x_t, y) = \frac{f(y)g(x_t|y)}{f(x_t)g(y|x_t)}$$ 

se transforma em  

$$r(x_t, y) = \frac{f(y)}{f(x_t)}$$  

e assim, o candidato $y$ é aceito com probabilidade  

$$\alpha(x_t, y) = min\bigg\{1,\frac{f(y)}{f(x_t)}\bigg \}.$$  

### Exemplo

Considere que a distribuição geradora de candidato é a ditribuição Normal, com média no atual estado da cadeia e variância constante, assim
$$
\begin{aligned}
g(x_t|y)&=\frac{1}{\sqrt{2\pi}\sigma}\exp\Big(-\frac{1}{2\sigma^2}(x_t-y)^2\Big),\\
g(y|x_t)&=\frac{1}{\sqrt{2\pi}\sigma}\exp\Big(-\frac{1}{2\sigma^2}(y-x_t)^2\Big),
\end{aligned}
$$
assim, 

$$g(x_t|y) = g(y|x_t).$$


# Metropolis com Proposta de Passeio Aleatório

O amostrador de Metrópolis com proposta de passeio aleatório é um exemplo do amostrador de Metropolis. Suponha que o candidato $y$ é gerado de uma distribuição de proposta simétrica $g(y|x_t) = g(|x_t-y|)$. Então, em cada iteração, um incremento aleatório $z$ é gerado a partir do $g(.)$, e $y$ é definido por  

$$y = x_t + z,$$  

por exemplo, o incremento aleatório pode ser normal com média zero, de modo que o candidato $Y|X_t \sim N(X_t, \sigma ^2),$ para algum $\sigma^2 > 0$ fixo.


A convergência é frequentemente sensível a escolha do parâmetro de escala. Quando a variância do incremento é muito grande, a maioria dos candidatos são rejeitados, e o algoritmo é pouco eficiente. Se a variância do incremento é muito pequena, os candidatos são quase todos aceitos, que também é ineficiente.  

## Exemplo 1

Seja $X_1,...,X_n$ uma amostra aleatória da distribuição Normal($\mu, \sigma^2$), sendo que $\sigma^2=1$. Considere como distribuição a priori para o parâmetro $\mu$ a t-Student com $v=4$ graus de liberdade. 

Utilize o Algoritmo de Metropolis com passeio aleatório e diferentes valores para a variância, compare as cadeias geradas. 


**Solução:**

Vamos considerar que os candidatos são gerados a partir do passeio aleatório com distribuição normal($0, \sigma_0^2)$. Para aplicar o algoritmo de Metropolis precisamos calcular a razão $r(x_t,y)$ que é dado por 

$$
\begin{aligned}
r(x_t,y)=& \frac{f(y)g(x_t|y)}{f(x_t)g(y|x_t)} \\
=& \frac{f(y)}{f(x_t)} \\
=&\frac{\Big(1+\frac{y^2}{v}\Big)^{(-\frac{v+1}{2})} \exp\Big(-\frac{1}{2}\sum_{i=1}^n(x_i-y)^2\Big)}
{\Big(1+\frac{x_t^2}{v}\Big)^{(-\frac{v+1}{2})} \exp\Big(-\frac{1}{2}\sum_{i=1}^n(x_i-x_t)^2\Big)}
\end{aligned}
$$
Vamos considerar que a variância do passeio aleatório é $0.2, 0.1, 0.05, 0.001$. 


```{r}
posteriori <- function(mu_){
  ((1+mu_^2/v)^{-(v+1)/2})*exp(-0.5*sum(x-mu_)^2)
}

r <-  function(x_, y){
  num <- posteriori(y)
  den <- posteriori(x_)
  return(num/den)
}

# amostra

set.seed(2023)
n <- 50
x <- rnorm(n)
summary(x)
sigma2_0 <- c(0.2, 0.1, 0.05, 0.001)

# MCMC
v <- 4
tamanho <- 4000
rejeicao <- numeric()
mu <- matrix(NA, ncol=4, nrow=tamanho)
mu[1, ] <- 1/2 # chute inicial

for(i in 1:4){
  u <- runif(tamanho)
  k <- 0 # taxa de rejeição
  for(t in 2:tamanho){
  y <-  mu[t-1, i] + rnorm(1,0, sigma2_0[i])  # gerando da passeio aleatorio com distribuição Normal com media 0 e vairancia sigma2_0
  aceita <- r(mu[t-1, i], y)
  if (u[t] <= aceita) {
    mu[t, i] <- y
  } else {
    mu[t, i] <- mu[t-1, i]
    k <- k + 1
  }
  }
  rejeicao[i] <- k/tamanho
} 


par(mfrow = c(2, 2))

plot(seq_along(mu[, 1]), mu[, 1], type = "l", 
     main = paste0("Sigma2 =", sigma2_0[1], ", rejeicao=", rejeicao[1]), col ="blue")

plot(seq_along(mu[, 2]), mu[, 2], type = "l", 
     main = paste0("Sigma2 =", sigma2_0[2], ", rejeicao=", rejeicao[2]), col ="red")


plot(seq_along(mu[, 3]), mu[, 3], type = "l", 
     main = paste0("Sigma2 =", sigma2_0[3], ", rejeicao=", rejeicao[3]), col ="green")


plot(seq_along(mu[, 4]), mu[, 4], type = "l", 
     main = paste0("Sigma2 =", sigma2_0[4], ", rejeicao=", rejeicao[4]), col ="yellow")

```


## Exercício - para entregar


Um estatístico está interessado em estimar a diferença entre as médias ($\theta = \mu_1-\mu_2)$ de duas populações Normais independentes com variância comum e iguais a 100. 

Uma amostra de tamanho 25 é selecionada de cada população fornecendo $\overline{x}_1=80.24537$ média amostral da primeira população e $\overline{x}_2=63.63234$ média amostral da segunda população. 


Suponha que a distribuição a priori é $\theta \sim N(10, 50)$. Determine a distribuição a posteriori de $\theta$ e obtenha as estimativas Bayesianas média e mediana a posteriori de $\theta$.  Compare os valores teóricos com os obtidos utilizando MCMC com passeio aleatório. 

```{r}
set.seed(2023)
x1 <- rnorm(25, 80, 10)
mean(x1)

x2 <- rnorm(25, 60, 10)
mean(x2)

```

**Solução**

